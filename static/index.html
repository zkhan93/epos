<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3"
      crossorigin="anonymous"
    />

    <title>EPOS Bihar</title>
  </head>
  <body>
    <!-- Optional JavaScript; choose one of the two! -->

    <!-- Option 1: Bootstrap Bundle with Popper -->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
      crossorigin="anonymous"
    ></script>

    <!-- Vue.js 3 -->

    <script src="https://cdn.jsdelivr.net/npm/axios@0.26.1/dist/axios.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/vue@3.2.31/dist/vue.global.min.js"></script>
    <div id="app" class="container">
      <div class="text-center mb-4 mt-3">
        <h1>
          EPOS Bihar
        </h1>

        <div>{{fpsid}}</div>
      </div>
      <div>
        <label>Select Month</label>
        <div class="input-group mb-3">
          <input
            name="year"
            v-model="year"
            class="form-control"
            type="number"
            aria-label="Year"
            placeholder="Year"
          />
          <select class="form-select" v-model="month">
            <option v-bind:value="m.index" v-for="m in months" :key="m.index"
              >{{m.name}}</option
            >
          </select>
        </div>
      </div>

      <div class="mb-3">
        <label>Search</label>
        <input
          v-model="search_rc_number"
          class="form-control"
          type="text"
          placeholder="Search by RC Number"
        />
      </div>
      <div v-if="loading">
        loading...
      </div>
      
      <div class="error" v-if="error">
        <div class="alert alert-danger" role="alert">
          <h4 class="alert-heading">Error Occurred!</h4>
          <p>{{error}}</p>
          <hr />
          <p>
            <ul >
            <li class="" v-for="line in traceback">
              {{line}} </li
            >
            </ul>
          </p>
        </div>
      </div>
      <div v-if="!loading && !error">
        <h3>Total entries {{items.length}}</h3>
        <div>
          <div
            class="card mb-2"
            v-for="item in filtered_items"
            :key="item['Sl No']"
          >
            <div class="card-header">
              {{item['RC No']}}
            </div>
            <ul class="list-group">
              <li
                class="list-group-item"
                v-for="header in headers"
                :key="header"
              >
                {{header}}: <b>{{item[header]}}</b>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
    <script>
      // POST here http://epos.bihar.gov.in/FPS_Trans_Details.jsp
      // with
      // dist_code=233 fps_id=123300100909 month=3 year=2022

      Vue.createApp({
        data() {
          return {
            loading: false,
            dist_code: 233,
            fpsid: 123300100909,
            year: new Date().getFullYear(),
            month: new Date().getMonth(),
            search_rc_number: "",
            error: "",
            traceback: "",
            items: [],
          };
        },
        computed: {
          headers() {
            if (this.items.length > 0) return Object.keys(this.items[0]);
            else return [];
          },
          filtered_items() {
            var key = "RC No";
            if (this.search_rc_number)
              return this.items.filter(
                (item) =>
                  item[key].startsWith(this.search_rc_number) ||
                  item[key].endsWith(this.search_rc_number)
              );
            else return this.items;
          },
          months() {
            var names = [
              "January",
              "February",
              "March",
              "April",
              "May",
              "June",
              "July",
              "August",
              "September",
              "October",
              "November",
              "December",
            ];
            var months = [];
            names.forEach((name, index) => {
              months.push({ index: index + 1, name: name });
            });
            return months;
          },
        },
        watch: {
          year() {
            this.fetch_items();
          },
          month() {
            this.fetch_items();
          },
        },
        mounted() {
          if (this.month == 0) this.month = 11;

          this.fetch_items();
        },
        methods: {
          fetch_items() {
            this.loading = true
            axios
              .get("http://localhost:5000/get-sales-details", {
                params: {
                  dist_code: this.dist_code,
                  fpsid: this.fpsid,
                  month: this.month,
                  year: this.year,
                },
              })
              .then((res) => {
                this.items.splice(0, this.items.length);
                res.data.forEach((item) => {
                  this.items.push(item);
                });
                this.loading = false
              })
              .catch((error) => {
                this.error = error;
                console.log(Object.keys(error))
                console.log(error.toJSON())
                if (error && error.response) {
                  this.error = error.response;
                  if (error.response.data) {
                    this.error = error.response.data;
                    if (error.response.data.error)
                      this.error = error.response.data.error;
                    if (error.response.data.traceback)
                      this.traceback = error.response.data.traceback;
                  }
                }
                this.loading = false
              });
          },
        },
      }).mount("#app");
    </script>
  </body>
</html>
